var global = window;

function App () {
    var self = this;

    $(document).ready(function() {
        $('[data-base]').val('<div class=" thing id-t3_47k0pn even  link " id="thing_t3_47k0pn" onclick="click_thing(this)" data-fullname="t3_47k0pn" data-type="link" data-author="110614" data-author-fullname="t2_ozztr" data-subreddit="videos" data-subreddit-fullname="t5_2qh1e" data-timestamp="1456421338000" data-domain="youtu.be" data-rank="2"><p class="parent"></p><span class="rank">2</span><div class="midcol unvoted"><div class="arrow up login-required access-required" data-event-action="upvote" role="button" aria-label="upvote" tabindex="0"></div><div class="score dislikes">4504</div><div class="score unvoted">4505</div><div class="score likes">4506</div><div class="arrow down login-required access-required" data-event-action="downvote" role="button" aria-label="downvote" tabindex="0"></div></div><a class="thumbnail may-blank loggedin " href="https://youtu.be/oI_LQ5lR4gU"><img src="//b.thumbs.redditmedia.com/pJ6eU9teG10n8Um3cvkMtyPN3TAvPmKYHHhE_RU5gkI.jpg" width="70" height="52" alt=""></a><div class="entry unvoted lcTagged"><p class="title"><a class="title may-blank loggedin  srTagged imgScanned" href="https://youtu.be/oI_LQ5lR4gU" tabindex="1">Gordon Ramsay tried Girl Scout Cookies for the first time.</a> <span class="domain">(<a href="/domain/youtu.be/">youtu.be</a>)</span></p><div class="expando-button collapsed video"></div><p class="tagline">submitted <time title="Thu Feb 25 17:28:58 2016 UTC" datetime="2016-02-25T17:28:58+00:00" class="live-timestamp">11 hours ago</time> by <a href="https://www.reddit.com/user/110614" class="author may-blank id-t2_ozztr userTagged">110614</a><span class="RESUserTag"><a class="userTagLink RESUserTagImage" username="110614" title="set a tag" href="javascript:void 0"></a></span> <a href="#" class="voteWeight" style="display: none;">[vw]</a><span class="userattrs"></span></p><ul class="flat-list buttons pocket-inserted"><li class="first"><a href="https://www.reddit.com/r/videos/comments/47k0pn/gordon_ramsay_tried_girl_scout_cookies_for_the/" class="comments may-blank">1720 comments</a></li><li class="share"><a class="post-sharing-button" href="javascript: void 0;">share</a></li><li class="link-save-button save-button"><a href="#">save</a></li><li><form action="/post/hide" method="post" class="state-button hide-button"><input type="hidden" name="executed" value="hidden"><span><a action="hide" href="#">hide</a></span></form></li><li class="report-button"><a href="javascript:void(0)" class="reportbtn access-required" data-event-action="report">report</a></li><li><span class="redditSingleClick" thislink="https://youtu.be/oI_LQ5lR4gU" thiscomments="https://www.reddit.com/r/videos/comments/47k0pn/gordon_ramsay_tried_girl_scout_cookies_for_the/">[l+c]</span></li><li><a class="pocket-reddit-button" href="#">pocket</a></li></ul><div class="reportform report-t3_47k0pn"></div><div class="expando expando-uninitialized" style="display: none" data-cachedhtml=" <iframe src=&quot;//www.redditmedia.com/mediaembed/47k0pn&quot; id=&quot;media-embed-47k0pn-hi9&quot; class=&quot;media-embed&quot; width=&quot;610&quot; height=&quot;348&quot; border=&quot;0&quot; frameBorder=&quot;0&quot; scrolling=&quot;no&quot; allowfullscreen></iframe> "><span class="error">loading...</span></div></div><div class="child"></div><div class="clearleft"></div></div>');
        $('[data-target]').val('<div class=" thing id-t3_47jqkp odd  link " id="thing_t3_47jqkp" onclick="click_thing(this)" data-fullname="t3_47jqkp" data-type="link" data-author="TangoJager" data-author-fullname="t2_itjgt" data-subreddit="videos" data-subreddit-fullname="t5_2qh1e" data-timestamp="1456418220000" data-domain="youtube.com" data-rank="3"><p class="parent"></p><span class="rank">3</span><div class="midcol unvoted"><div class="arrow up login-required access-required" data-event-action="upvote" role="button" aria-label="upvote" tabindex="0"></div><div class="score dislikes">2452</div><div class="score unvoted">2453</div><div class="score likes">2454</div><div class="arrow down login-required access-required" data-event-action="downvote" role="button" aria-label="downvote" tabindex="0"></div></div><a class="thumbnail may-blank loggedin " href="https://www.youtube.com/watch?v=5UE3jz_O_EM"><img src="//a.thumbs.redditmedia.com/h_I1ltAatPFiMstdz3NY7PiMBvl_gwZi4ppzjtIvuF4.jpg" width="70" height="52" alt=""></a><div class="entry unvoted lcTagged"><p class="title"><a class="title may-blank loggedin  srTagged imgScanned" href="https://www.youtube.com/watch?v=5UE3jz_O_EM" tabindex="1">Joel &amp; Ethan Coen - Shot | Reverse Shot</a> <span class="domain">(<a href="/domain/youtube.com/">youtube.com</a>)</span></p><div class="expando-button collapsed video"></div><p class="tagline">submitted <time title="Thu Feb 25 16:37:00 2016 UTC" datetime="2016-02-25T16:37:00+00:00" class="live-timestamp">12 hours ago</time> by <a href="https://www.reddit.com/user/TangoJager" class="author may-blank id-t2_itjgt userTagged">TangoJager</a><span class="RESUserTag"><a class="userTagLink RESUserTagImage" username="tangojager" title="set a tag" href="javascript:void 0"></a></span> <a href="#" class="voteWeight" style="display: none;">[vw]</a><span class="userattrs"></span></p><ul class="flat-list buttons pocket-inserted"><li class="first"><a href="https://www.reddit.com/r/videos/comments/47jqkp/joel_ethan_coen_shot_reverse_shot/" class="comments may-blank">179 comments</a></li><li class="share"><a class="post-sharing-button" href="javascript: void 0;">share</a></li><li class="link-save-button save-button"><a href="#">save</a></li><li><form action="/post/hide" method="post" class="state-button hide-button"><input type="hidden" name="executed" value="hidden"><span><a action="hide" href="#">hide</a></span></form></li><li class="report-button"><a href="javascript:void(0)" class="reportbtn access-required" data-event-action="report">report</a></li><li><span class="redditSingleClick" thislink="https://www.youtube.com/watch?v=5UE3jz_O_EM" thiscomments="https://www.reddit.com/r/videos/comments/47jqkp/joel_ethan_coen_shot_reverse_shot/">[l+c]</span></li><li><a class="pocket-reddit-button" href="#">pocket</a></li></ul><div class="reportform report-t3_47jqkp"></div><div class="expando expando-uninitialized" style="display: none" data-cachedhtml=" <iframe src=&quot;//www.redditmedia.com/mediaembed/47jqkp&quot; id=&quot;media-embed-47jqkp-2qq&quot; class=&quot;media-embed&quot; width=&quot;610&quot; height=&quot;348&quot; border=&quot;0&quot; frameBorder=&quot;0&quot; scrolling=&quot;no&quot; allowfullscreen></iframe> "><span class="error">loading...</span></div></div><div class="child"></div><div class="clearleft"></div></div>');

        var source   = $("#tooltip-template").html();
        window.tooltipTemplate = Handlebars.compile(source);

        window.tooltip = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0);

        self.onClick();

        $("#analyze").click(self.onClick.bind(self));
    });


}

App.prototype.onClick = function() {
    this.beautify();
    var str = $('[data-base]').get(0).value;
    var baseDom = this.parseString(str);
    var baseRoot = this.castToNodes(baseDom.get(0), null);

    var str = $('[data-target]').get(0).value;
    var targetDom = this.parseString(str);
    var targetRoot = this.castToNodes(targetDom.get(0), null);
    this.visualize(baseRoot, targetRoot);
};

App.prototype.beautify = function() {
};

App.prototype.visualize = function(base, target) {
    create_normal("baseVisual", base, d3.layout.tree());
    create_normal("targetVisual", target, d3.layout.tree());
};

App.prototype.castToNodes = function(domNode, parent) {
    var node = new Node(domNode, parent);
    var self = this;
    for(var i = 0; i < domNode.children.length; i++) {
        var child = domNode.children[i];
        node.children.push(self.castToNodes(child, domNode));
    }
    return node;
};

App.prototype.parseString = function(str) {
    return $(str);
};

function Node(dom, parent) {
    this.tagName = dom.tagName;
    this.parent = parent;
    this.className = dom.getAttribute('class');
    this.style = dom.getAttribute('style');
    this.children = [];
}

new App();
